<!DOCTYPE html>
<html lang="en">
<head>
  <title>SentiraX ‚Äì AI Mood-Based Movie & Show Companion</title>
  <meta name="description" content="SentiraX uses AI and TMDB to help you choose what to watch next based on your mood. Check in with how you feel and get tailored movie & show recommendations.">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta charset="UTF-8">

  <link rel="canonical" href="https://sentirax.vercel.app/">

  <!-- Open Graph -->
  <meta property="og:type" content="website">
  <meta property="og:site_name" content="SentiraX">
  <meta property="og:title" content="SentiraX ‚Äì Your Mood-Based Watch Companion">
  <meta property="og:description" content="Tell SentiraX how you feel and get movie & show recommendations that match your mood.">
  <meta property="og:url" content="https://sentirax.vercel.app/">
  <meta property="og:image" content="https://sentirax.vercel.app/og-image.png">

  <!-- Twitter -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="SentiraX ‚Äì Your Mood-Based Watch Companion">
  <meta name="twitter:description" content="AI-powered mood-based viewing. Check in with your mood and discover movies & shows that fit how you feel.">
  <meta name="twitter:image" content="https://sentirax.vercel.app/og-image.png">

  <!-- JSON-LD -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "WebSite",
    "url": "https://sentirax.vercel.app/",
    "name": "SentiraX",
    "description": "SentiraX is an AI-powered mood-based movie & show companion that helps you choose what to watch next based on how you feel.",
    "publisher": {
      "@type": "Organization",
      "name": "SentiraX",
      "logo": {
        "@type": "ImageObject",
        "url": "https://sentirax.vercel.app/icons/icon-192.png"
      }
    }
  }
  </script>

  <link rel="icon" href="/icons/icon-192.png">
  <link rel="apple-touch-icon" href="/icons/icon-192.png">
  <meta name="theme-color" content="#020617">
  <link rel="manifest" href="manifest.json">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Crimson+Pro:wght@300;400;600&display=swap" rel="stylesheet">

  <style>
    :root {
      --accent: #22c55e;
      --accent2: #22d3ee;
      --bg: #020617;
      --surface: #0b1220;
      --surface-soft: #020617;
      --border-subtle: #1f2937;
      --text-main: #e5e7eb;
      --text-muted: #9ca3af;
      --highlight: #4ade80;
      --danger: #f97316;
    }
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: 'Crimson Pro', serif;
      background: var(--bg);
      color: var(--text-main);
      line-height: 1.6;
      overflow-x: hidden;
    }
    h1, h2, h3, h4 {
      font-family: 'Playfair Display', serif;
      font-weight: 600;
    }
    a { color: inherit; }

    .app-container {
      max-width: 100%;
      margin: 0 auto;
      min-height: 100vh;
      background: var(--bg);
      position: relative;
      padding-left: 1rem;
      padding-right: 1rem;
    }
    @media (min-width: 640px) {
      .app-container {
        max-width: 600px;
        padding-left: 1.5rem;
        padding-right: 1.5rem;
      }
    }
    @media (min-width: 900px) {
      .app-container {
        max-width: 900px;
        padding-left: 2rem;
        padding-right: 2rem;
      }
    }
    @media (min-width: 1280px) {
      .app-container {
        max-width: 1200px;
        padding-left: 3rem;
        padding-right: 3rem;
      }
    }

    .bg-pattern {
      position: fixed;
      inset: 0;
      opacity: 0.25;
      background:
        radial-gradient(circle at top, rgba(34,197,94,0.12), transparent 55%),
        radial-gradient(circle at 70% 20%, rgba(56,189,248,0.10), transparent 55%),
        radial-gradient(circle at bottom, rgba(15,23,42,0.9), #020617 60%);
      pointer-events: none;
      z-index: 0;
    }
    .content {
      position: relative;
      z-index: 1;
    }

    .app-header {
      background: radial-gradient(circle at top left, #0f172a, #020617 60%);
      border-bottom: 1px solid var(--border-subtle);
      padding: 1rem 1.5rem;
      box-shadow: 0 18px 40px rgba(0,0,0,0.7);
    }
    @media (min-width: 640px) {
      .app-header { padding: 1.25rem 1.5rem; }
    }
    .logo {
      font-family: 'Playfair Display', serif;
      font-size: 1.5rem;
      font-weight: 700;
      letter-spacing: 0.08em;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      color: #f9fafb;
    }
    @media (min-width: 640px) {
      .logo { font-size: 1.75rem; }
    }

    .btn {
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 999px;
      font-family: 'Crimson Pro', serif;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      text-align: center;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.4rem;
      width: 100%;
    }
    @media (min-width: 640px) {
      .btn { width: auto; }
    }
    .btn-primary {
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      color: #022c22;
      box-shadow: 0 14px 40px rgba(34,197,94,0.35);
    }
    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 18px 50px rgba(34,197,94,0.45);
    }
    .btn-secondary {
      background: #020617;
      border: 1px solid var(--border-subtle);
      color: var(--text-main);
    }
    .btn-secondary:hover {
      border-color: var(--accent);
      box-shadow: 0 8px 30px rgba(15,23,42,0.9);
      transform: translateY(-1px);
    }
    .btn-ghost {
      background: transparent;
      color: var(--text-muted);
      text-decoration: none;
      border-radius: 999px;
      padding: 0.4rem 0.8rem;
      border: 1px solid transparent;
      font-size: 0.85rem;
      cursor: pointer;
    }
    .btn-ghost:hover {
      border-color: var(--border-subtle);
      color: var(--accent);
    }

    .cookie-banner {
  position: fixed;
  bottom: 0;
  left: 0;
  width: 100%;
  background: #111;
  color: #fff;
  padding: 1rem;
  z-index: 9999;
  box-shadow: 0 -2px 8px rgba(0,0,0,0.2);
}

.cookie-banner.hidden {
  display: none;
}

.cookie-content {
  max-width: 900px;
  margin: auto;
  display: flex;
  flex-direction: column;
  gap: 1rem;
}

.cookie-banner a {
  color: #4dabff;
}

#cookie-accept-btn {
  background: #4dabff;
  border: none;
  padding: 0.6rem 1.2rem;
  border-radius: 6px;
  color: #fff;
  font-weight: bold;
  cursor: pointer;
  align-self: flex-start;
}
  
#cookie-reject-btn {
  background: #333;
  border: 1px solid #666;
  padding: 0.6rem 1.2rem;
  border-radius: 6px;
  color: #fff;
  cursor: pointer;
  margin-left: 0.5rem;
}

    .form-group { margin-bottom: 1.5rem; }
    .form-label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 600;
      color: var(--text-muted);
      font-size: 0.9rem;
    }
    .form-input,
    .form-select,
    .form-textarea {
      width: 100%;
      padding: 0.7rem 0.85rem;
      border-radius: 10px;
      border: 1px solid var(--border-subtle);
      background: #020617;
      color: var(--text-main);
      font-family: inherit;
      font-size: 0.95rem;
      outline: none;
      transition: border-color 0.15s ease, box-shadow 0.15s ease, background 0.15s ease;
    }
    .form-input:focus,
    .form-select:focus,
    .form-textarea:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(34,197,94,0.5);
      background: #020617;
    }
    .form-textarea {
      resize: vertical;
      min-height: 90px;
    }

    .install-btn {
  padding: 0.7rem 1.4rem;
  border: 1px solid var(--border-subtle);
  background: #020617;
  color: var(--text-main);
  border-radius: 999px;
  font-family: 'Crimson Pro', serif;
  font-size: 0.9rem;
  cursor: pointer;
  transition: all .2s ease;
  display: inline-flex;
  align-items: center;
  gap: 0.4rem;
  width: auto;
  box-shadow: 0 12px 28px rgba(0,0,0,0.5);
  margin-top: .4rem;
}

.install-btn:hover {
  border-color: var(--accent);
  color: var(--accent);
  transform: translateY(-1px);
  box-shadow: 0 18px 40px rgba(34,197,94,0.35);
}

.install-btn.hidden {
  display: none !important;
}

    .mood-slider {
      -webkit-appearance: none;
      appearance: none;
      width: 100%;
      height: 8px;
      border-radius: 999px;
      background: linear-gradient(to right, #f97316, #eab308, #22c55e);
      outline: none;
      opacity: 0.9;
      transition: opacity 0.15s ease;
    }
    .mood-slider:hover { opacity: 1; }
    .mood-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 20px;
      height: 20px;
      border-radius: 999px;
      background: #f9fafb;
      border: 2px solid var(--accent);
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(0,0,0,0.35);
    }
    .mood-slider::-moz-range-thumb {
      width: 20px;
      height: 20px;
      border-radius: 999px;
      background: #f9fafb;
      border: 2px solid var(--accent);
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(0,0,0,0.35);
    }

    .mood-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-top: 0.5rem;
    }
    .mood-tag {
      padding: 0.45rem 0.85rem;
      border-radius: 999px;
      border: 1px solid var(--border-subtle);
      background: #020617;
      color: var(--text-muted);
      font-size: 0.8rem;
      cursor: pointer;
      transition: all 0.15s ease;
    }
    .mood-tag:hover {
      border-color: var(--accent);
      color: var(--text-main);
    }
    .mood-tag.selected {
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      border-color: transparent;
      color: #022c22;
    }

    .card {
      background: radial-gradient(circle at top left, #020617, #020617 60%);
      border-radius: 16px;
      border: 1px solid var(--border-subtle);
      padding: 1.2rem 1.35rem 1.4rem;
      box-shadow: 0 18px 40px rgba(0,0,0,0.75);
      margin-bottom: 1.5rem;
    }

    .title-banner {
  width: 100%;
  border-radius: 12px;
  margin-bottom: 0.7rem;
  max-height: 420px;         /* higher cap */
  object-fit: contain;
  background-color: #020617;
}

    .title-card {
      background: #020617;
      border-radius: 16px;
      border: 1px solid var(--border-subtle);
      padding: 0.9rem 1rem 1rem;
      box-shadow: 0 14px 32px rgba(0,0,0,0.7);
      margin-bottom: 0.75rem;
      cursor: pointer;
      transition: transform 0.12s ease, box-shadow 0.12s ease, border-color 0.12s ease;
    }
    .title-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 20px 45px rgba(0,0,0,0.9);
      border-color: rgba(34,197,94,0.5);
    }

    .title-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 0.75rem;
    }
    .title-main {
      display: flex;
      flex-direction: column;
      gap: 0.2rem;
    }
    .title-name {
      font-size: 1rem;
      font-weight: 600;
      color: #f9fafb;
    }
    .badge-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.3rem;
    }
    .badge {
      border-radius: 999px;
      border: 1px solid var(--border-subtle);
      padding: 0.15rem 0.5rem;
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--text-muted);
    }
    .badge-18 {
      background: rgba(127,29,29,0.9);
      border-color: #b91c1c;
      color: #fee2e2;
    }
    .badge-type {
      border-color: rgba(34,197,94,0.5);
      color: #bbf7d0;
    }
    .reason-text,
    .summary-text {
      font-size: 0.85rem;
      color: var(--text-muted);
      margin-top: 0.4rem;
    }

    .stream-row {
      margin-top: 0.5rem;
      display: flex;
      flex-wrap: wrap;
      gap: 0.35rem;
    }
    .stream-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0.3rem 0.7rem;
      border-radius: 999px;
      border: 1px solid var(--border-subtle);
      background: #020617;
      font-size: 0.75rem;
      text-decoration: none;
      color: var(--text-muted);
      transition: all 0.12s ease;
    }
    .stream-btn:hover {
      border-color: var(--accent);
      color: var(--text-main);
    }

    .section-label {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--text-muted);
      margin-bottom: 0.4rem;
    }

    .loading {
      text-align: center;
      padding: 2.5rem 1rem;
    }
    .spinner {
      width: 40px;
      height: 40px;
      border-radius: 999px;
      border: 3px solid #0b1220;
      border-top: 3px solid var(--accent);
      animation: spin 0.8s linear infinite;
      margin: 0 auto 0.75rem;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(18px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .nav-bar {
      position: sticky;
      bottom: 0;
      background: #020617;
      border-top: 1px solid var(--border-subtle);
      display: flex;
      justify-content: space-around;
      padding: 0.4rem;
      box-shadow: 0 -12px 40px rgba(0,0,0,0.9);
      z-index: 5;
    }
    @media (min-width: 900px) {
      .nav-bar {
        border-top: none;
        box-shadow: none;
        justify-content: flex-end;
        gap: 0.6rem;
      }
    }
    .nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.15rem;
      padding: 0.4rem 0.6rem;
      cursor: pointer;
      color: var(--text-muted);
      opacity: 0.7;
      font-size: 0.7rem;
      flex: 1;
      transition: color 0.15s ease, opacity 0.15s ease, transform 0.1s ease;
    }
    @media (min-width: 900px) {
      .nav-item {
        flex: 0 0 auto;
        flex-direction: row;
        gap: 0.35rem;
        font-size: 0.78rem;
      }
    }
    .nav-item span:first-child { font-size: 1.2rem; }
    .nav-item.active,
    .nav-item:hover {
      color: var(--accent);
      opacity: 1;
      transform: translateY(-1px);
    }

    .site-footer {
      padding: 1.5rem 1rem 2.5rem;
      border-top: 1px solid rgba(15,23,42,0.7);
      font-size: 0.85rem;
      background: transparent;
    }
    .footer-inner {
      display: flex;
      flex-direction: column;
      gap: 1.4rem;
    }
    @media (min-width: 640px) {
      .footer-inner {
        flex-direction: row;
        justify-content: space-between;
        gap: 2rem;
      }
    }
    .footer-logo {
      font-weight: 700;
      text-decoration: none;
      color: #f9fafb;
    }
    .footer-tagline {
      margin-top: 0.2rem;
      color: var(--text-muted);
      max-width: 240px;
    }
    .footer-nav {
      display: flex;
      flex-wrap: wrap;
      gap: 1.4rem;
    }
    .footer-column h3 {
      margin-bottom: 0.45rem;
      font-size: 0.78rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--text-muted);
    }
    .footer-column ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .footer-column li { margin-bottom: 0.25rem; }
    .footer-column a {
      font-size: 0.82rem;
      color: var(--text-muted);
      text-decoration: none;
    }
    .footer-column a:hover { color: var(--accent); }
    .footer-bottom {
      margin-top: 1.2rem;
      text-align: center;
      color: var(--text-muted);
      font-size: 0.78rem;
    }

    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,0.9);
      backdrop-filter: blur(6px);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 50;
      padding: 1rem;
      animation: fadeInUp 0.2s ease;
    }
    .modal-content {
      background: #020617;
      border-radius: 16px;
      border: 1px solid var(--border-subtle);
      padding: 1.4rem 1.6rem;
      max-width: 440px;
      width: 100%;
      box-shadow: 0 30px 80px rgba(0,0,0,0.9);
    }

    .center-block {
      max-width: 640px;
      margin: 0 auto;
    }
    .responsive-padding {
      padding: 1.4rem 0 2.2rem;
      min-height: calc(100vh - 210px);
    }
    .responsive-heading {
      font-size: 1.6rem;
    }
    @media (min-width: 640px) {
      .responsive-heading { font-size: 2rem; }
    }

    .detail-section-title {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--text-muted);
      margin-top: 0.75rem;
      margin-bottom: 0.25rem;
    }
    ul.cast-list {
      list-style: none;
      padding: 0;
      margin: 0.25rem 0 0;
    }
    ul.cast-list li {
      font-size: 0.8rem;
      color: var(--text-main);
      margin-bottom: 0.1rem;
    }

    .providers-groups {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-top: 0.25rem;
    }
    .provider-group {
      border-radius: 10px;
      border: 1px solid var(--border-subtle);
      padding: 0.5rem 0.7rem;
      background: #020617;
    }
    .provider-group-title {
      font-size: 0.7rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.12em;
      margin-bottom: 0.1rem;
    }
    .provider-name {
      font-size: 0.8rem;
      color: var(--text-main);
    }

    .small-text { font-size: 0.82rem; color: var(--text-muted); }
    .error-text { font-size: 0.8rem; color: #fecaca; margin-top: 0.4rem; }

    .hidden { display: none !important; }

    .wiki-fullscreen-controls {
  display: flex;
  align-items: center;
  gap: 0.4rem;
}

    .wiki-modal {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.85);
  backdrop-filter: blur(4px);
  color: #e5e7eb;
  display: flex;
  justify-content: center;
  align-items: flex-start;
  padding: 2rem 1rem;
  overflow-y: auto;
  z-index: 9999;
  transition: opacity 0.25s ease;
}

.wiki-modal.hidden {
  opacity: 0;
  pointer-events: none;
}

.wiki-modal-content {
  background: #0f172a;
  padding: 1.8rem;
  border-radius: 1rem;
  max-width: 700px;
  width: 100%;
  box-shadow: 0 20px 40px rgba(0,0,0,0.4);
  animation: wikiFadeIn 0.25s ease;
}

@keyframes wikiFadeIn {
  from { transform: translateY(20px); opacity: 0; }
  to { transform: translateY(0); opacity: 1; }
}
    
.wiki-nav-btn,
.wiki-close-btn {
  width: 32px;
  height: 32px;
  border-radius: 999px;
  border: none;
  background: rgba(15, 23, 42, 0.9);
  display: inline-flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  padding: 0;
  transition: background 0.15s ease, opacity 0.15s ease, transform 0.1s ease;
  color: #e5e7eb;
}
    .wiki-nav-btn svg {
  width: 18px;
  height: 18px;
  fill: currentColor;
}
    .wiki-nav-btn:hover:not(:disabled),
.wiki-close-btn:hover {
  background: rgba(148, 163, 184, 0.25);
  transform: translateY(-1px);
}

.wiki-nav-btn:hover,
.wiki-close-btn:hover {
  background: #3a3a44;
}
    
.wiki-nav-btn:disabled {
  opacity: 0.35;
  cursor: default;
}
    .wiki-close-btn {
  font-size: 0.9rem;
}

  </style>
</head>
<body>
  <div class="bg-pattern"></div>
  <div class="app-container">
    <div class="content">
      <header class="app-header" id="appHeader">
        <div class="logo">
          <span>üé¨</span>
          <span>SentiraX</span>
        </div>
        <p style="font-size: 0.9rem; margin-top: 0.2rem; color: var(--text-muted);">
          your mood-based watching companion.
        </p>
      </header>

      <main id="mainContent" class="responsive-padding">
        <!-- JS injects views -->
      </main>

      <footer class="site-footer">
        <div class="footer-inner">
          <div class="footer-brand">
            <a href="/" class="footer-logo">SentiraX</a>
            <p class="footer-tagline">
              Your mood-based watching companion.
            </p>
          </div>
          <!-- ‚≠ê INSTALL PWA BUTTON (initially hidden) -->
    <button id="installPwaBtn" class="install-btn hidden">
      üì≤ Install SentiraX
    </button>

          <nav class="footer-nav">
            <div class="footer-column">
              <h3>Product</h3>
              <ul>
                <li><a href="/">Home</a></li>
                <li><a href="#">How it works</a></li>
              </ul>
            </div>
            <div class="footer-column">
              <h3>Guides</h3>
              <ul>
                <li><a href="#">Mood-based watching</a></li>
                <li><a href="#">Using AI for discovery</a></li>
              </ul>
            </div>
            <div class="footer-column">
              <h3>Legal</h3>
              <ul>
                <li><a href="#">Privacy</a></li>
                <li><a href="#">Terms</a></li>
              </ul>
            </div>
          </nav>
        </div>

        <button id="cookie-settings-btn" class="btn btn-secondary">
  Cookie Settings
</button>

        <div class="footer-bottom">
          <p>¬© <span id="year"></span> SentiraX. All rights reserved.</p>
        </div>
      </footer>

      <nav class="nav-bar" id="navBar" style="display:none;">
        <div class="nav-item" data-view="check-in">
          <span>üåô</span>
          <span>Check-in</span>
        </div>
        <div class="nav-item" data-view="recommendations">
          <span>‚ú®</span>
          <span>Discover</span>
        </div>
        <div class="nav-item" data-view="watchlist">
          <span>üì∫</span>
          <span>Watchlist</span>
        </div>
        <div class="nav-item" data-view="settings">
          <span>‚öôÔ∏è</span>
          <span>Settings</span>
        </div>
      </nav>
    </div>
  </div>

  <script>
  // Footer year
  document.addEventListener("DOMContentLoaded", () => {
    const yearEl = document.getElementById("year");
    if (yearEl) yearEl.textContent = new Date().getFullYear();
  });

  // Backend URL for SentiraX
  const BACKEND_BASE_URL = "https://sentirax-backend.onrender.com";

  // Simple storage wrapper
  const Storage = {
    get(key, fallback = null) {
      try {
        const raw = localStorage.getItem("sentirax_" + key);
        if (!raw) return fallback;
        return JSON.parse(raw);
      } catch {
        return fallback;
      }
    },
    set(key, value) {
      try {
        localStorage.setItem("sentirax_" + key, JSON.stringify(value));
      } catch {}
    },
    remove(key) {
      try {
        localStorage.removeItem("sentirax_" + key);
      } catch {}
    },
    clearAll() {
      ["user_profile", "watchlist", "checkins"].forEach(k => Storage.remove(k));
    }
  };

  const AppState = {
    user: null,
    watchlist: [],
    checkins: [],
    currentView: "welcome",
    lastCheckIn: null,
    recommendations: [],
    lastSummary: "",
    selectedTitle: null,
    detailsCache: {},

    init() {
      this.user = Storage.get("user_profile", null);
      this.watchlist = Storage.get("watchlist", []);
      this.checkins = Storage.get("checkins", []);
      if (this.user) this.currentView = "check-in";
    },

    saveUser(profile) {
      this.user = profile;
      Storage.set("user_profile", profile);
    },

    saveCheckIn(checkIn) {
      this.lastCheckIn = checkIn;
      this.checkins.push({ ...checkIn, ts: new Date().toISOString() });
      Storage.set("checkins", this.checkins);
    },

    addToWatchlist(item) {
      if (!this.watchlist.find(x => x.id === item.id)) {
        this.watchlist.push(item);
        Storage.set("watchlist", this.watchlist);
      }
    },

    removeFromWatchlist(id) {
      this.watchlist = this.watchlist.filter(x => x.id !== id);
      Storage.set("watchlist", this.watchlist);
    },

    reset() {
      this.user = null;
      this.watchlist = [];
      this.checkins = [];
      this.currentView = "welcome";
      this.recommendations = [];
      this.selectedTitle = null;
      this.detailsCache = {};
      Storage.clearAll();
    }
  };

  const Router = {
    navigate(view, data = {}) {
      AppState.currentView = view;
      const navBar = document.getElementById("navBar");
      if (["welcome", "onboarding"].includes(view)) {
        navBar.style.display = "none";
      } else {
        navBar.style.display = "flex";
      }

      document.querySelectorAll(".nav-item").forEach(item => {
        item.classList.toggle("active", item.dataset.view === view);
      });

      this.render(view, data);
    },

    render(view, data) {
      const main = document.getElementById("mainContent");
      switch (view) {
        case "welcome":
          main.innerHTML = Views.welcome();
          break;
        case "onboarding":
          main.innerHTML = Views.onboarding();
          Views.initOnboarding();
          break;
        case "check-in":
          main.innerHTML = Views.checkIn();
          Views.initCheckIn();
          break;
        case "recommendations":
          main.innerHTML = Views.recommendations();
          Views.initRecommendations();
          break;
        case "detail":
          main.innerHTML = Views.detail(data.title);
          Views.initDetail(data.title);
          break;
        case "watchlist":
          main.innerHTML = Views.watchlist();
          Views.initWatchlist();
          break;
        case "settings":
          main.innerHTML = Views.settings();
          break;
        default:
          main.innerHTML = "<p>View not found</p>";
      }
      window.scrollTo(0, 0);
    }
  };

  const Views = {
    // ---- Wikipedia fullscreen navigation state ----
    _wikiHistory: [],
    _wikiHistoryIndex: 0,

    welcome() {
      return `
        <div class="center-block" style="padding:2.2rem 0;">
          <div style="font-size:3.4rem; margin-bottom:1rem; text-align:center; animation:fadeInUp .5s ease;">
            üçø
          </div>
          <h1 class="responsive-heading" style="text-align:center; margin-bottom:0.8rem; animation:fadeInUp .5s ease .05s; animation-fill-mode:both;">
            Welcome to SentiraX
          </h1>
          <p style="text-align:center; color:var(--text-muted); margin-bottom:1.7rem; animation:fadeInUp .5s ease .1s; animation-fill-mode:both;">
            Mood-aware movie and show picks, tuned to what you feel like right now; not just what‚Äôs trending.
          </p>
          <div class="card" style="margin-bottom:1.8rem; animation:fadeInUp .5s ease .15s; animation-fill-mode:both;">
            <div class="section-label">Note</div>
            <p class="small-text">
              SentiraX suggests entertainment based on your mood and preferences. It‚Äôs not a mental health tool and does not replace professional help. 
              If you‚Äôre in crisis or struggling heavily, please reach out to a qualified professional or local emergency service.
            </p>
          </div>
          <div style="text-align:center; animation:fadeInUp .5s ease .2s; animation-fill-mode:both;">
            <button class="btn btn-primary" onclick="Router.navigate('onboarding')">
              Get Started
            </button>
          </div>
        </div>
      `;
    },

    onboarding() {
      return `
        <div class="center-block">
          <h2 class="responsive-heading" style="margin-bottom:1.2rem;">Let‚Äôs set your baseline</h2>
          <p class="small-text" style="margin-bottom:1.5rem;">
            Age is required so we can safely handle 18+ content. Everything else just helps SentiraX learn your taste.
          </p>
          <div class="card">
            <div class="form-group">
              <label class="form-label">Age <span style="color:var(--danger);">*</span></label>
              <input type="number" id="ageInput" min="13" max="120" class="form-input" placeholder="21">
              <div id="ageError" class="error-text hidden">Please enter a valid age (13+).</div>
            </div>
            <div class="form-group">
              <label class="form-label">Gender (optional)</label>
              <select id="genderInput" class="form-select">
                <option value="">Prefer not to say</option>
                <option value="female">Female</option>
                <option value="male">Male</option>
                <option value="non-binary">Non-binary</option>
                <option value="other">Other</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Genres you enjoy (optional)</label>
              <div id="likedGenres" class="mood-tags"></div>
            </div>
            <div class="form-group">
              <label class="form-label">Genres to avoid (optional)</label>
              <div id="dislikedGenres" class="mood-tags"></div>
            </div>
            <div class="form-group">
              <label class="form-label">Your usual goals (optional)</label>
              <div id="goals" class="mood-tags"></div>
            </div>
            <div class="form-group" style="display:flex;align-items:center;gap:.5rem;">
              <input type="checkbox" id="allowAdult" style="accent-color:#22c55e; width:18px; height:18px;">
              <label for="allowAdult" class="form-label" style="margin-bottom:0;">Allow 18+ content (adult films)</label>
            </div>
            <p class="small-text">
              18+ content is only considered if your age is 18+ and this toggle is on.
            </p>
            <div style="margin-top:1.3rem; display:flex; gap:.6rem; flex-wrap:wrap;">
              <button class="btn btn-primary" onclick="Views.saveOnboarding()">Save & continue</button>
            </div>
          </div>
        </div>
      `;
    },

    initOnboarding() {
      const likedGenres = [
        "Action", "Comedy", "Drama", "Romance", "Horror",
        "Thriller", "Sci-Fi", "Fantasy", "Anime", "Documentary",
        "Crime", "Mystery", "Adventure"
      ];
      const goals = [
        "Escape and relax", "Laugh", "Get inspired", "Learn something",
        "Background noise", "Watch with friends", "Date night"
      ];

      function renderChips(containerId, values) {
        const el = document.getElementById(containerId);
        el.innerHTML = "";
        values.forEach(v => {
          const div = document.createElement("div");
          div.className = "mood-tag";
          div.dataset.value = v;
          div.textContent = v;
          div.onclick = () => div.classList.toggle("selected");
          el.appendChild(div);
        });
      }

      renderChips("likedGenres", likedGenres);
      renderChips("dislikedGenres", likedGenres);
      renderChips("goals", goals);

      const stored = AppState.user;
      const ageInput = document.getElementById("ageInput");

      if (stored) {
        ageInput.value = stored.age || "";
        document.getElementById("genderInput").value = stored.gender || "";
        if (stored.liked_genres) {
          stored.liked_genres.forEach(g => {
            const chip = document.querySelector(`#likedGenres .mood-tag[data-value="${g}"]`);
            if (chip) chip.classList.add("selected");
          });
        }
        if (stored.disliked_genres) {
          stored.disliked_genres.forEach(g => {
            const chip = document.querySelector(`#dislikedGenres .mood-tag[data-value="${g}"]`);
            if (chip) chip.classList.add("selected");
          });
        }
        if (stored.goals) {
          stored.goals.forEach(g => {
            const chip = document.querySelector(`#goals .mood-tag[data-value="${g}"]`);
            if (chip) chip.classList.add("selected");
          });
        }
        if (stored.allow_adult) {
          document.getElementById("allowAdult").checked = true;
        }
      }

      ageInput.addEventListener("input", () => {
        const v = Number(ageInput.value || 0);
        const allow = document.getElementById("allowAdult");
        if (v < 18) {
          allow.checked = false;
          allow.disabled = true;
        } else {
          allow.disabled = false;
        }
      });

      if (stored?.age) {
        ageInput.dispatchEvent(new Event("input"));
      }
    },

    saveOnboarding() {
      const ageEl = document.getElementById("ageInput");
      const age = Number(ageEl.value || 0);
      const err = document.getElementById("ageError");
      if (!age || age < 13 || age > 120) {
        err.classList.remove("hidden");
        return;
      }
      err.classList.add("hidden");

      function getSelected(containerId) {
        return Array.from(document.querySelectorAll(`#${containerId} .mood-tag.selected`))
          .map(x => x.dataset.value);
      }

      const gender = document.getElementById("genderInput").value || null;
      const profile = {
        age,
        gender,
        liked_genres: getSelected("likedGenres"),
        disliked_genres: getSelected("dislikedGenres"),
        goals: getSelected("goals"),
        allow_adult: age >= 18 && document.getElementById("allowAdult").checked
      };

      AppState.saveUser(profile);
      Router.navigate("check-in");
    },

    checkIn() {
      return `
        <div class="center-block">
          <h2 class="responsive-heading" style="margin-bottom:1rem;">How are you feeling today?</h2>
          <p class="small-text" style="margin-bottom:1.8rem;">
            Tell SentiraX how you feel right now.
          </p>
          <div class="card">
            <div class="form-group">
              <label class="form-label">Mood intensity</label>
              <input type="range" id="moodSlider" class="mood-slider" min="1" max="10" value="5" aria-describedby="moodLabel">
              <div style="display:flex;justify-content:space-between;margin-top:.4rem;font-size:.78rem;color:var(--text-muted);">
                <span>Low energy</span>
                <span id="moodLabel">Neutral (5)</span>
                <span>High energy</span>
              </div>
            </div>
            <div class="form-group">
              <label class="form-label">Mood tags (optional)</label>
              <div id="moodTags" class="mood-tags"></div>
            </div>
            <div class="form-group">
              <label class="form-label">What are you in the mood for? (optional)</label>
              <textarea id="freeText" class="form-textarea" placeholder="e.g. cozy romcom, no heavy drama, can be a series"></textarea>
            </div>
            <div class="form-group">
              <label class="form-label">Type</label>
              <select id="typeFilter" class="form-select">
                <option value="any">Movies or shows</option>
                <option value="movie">Movies only</option>
                <option value="show">Shows only</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Max duration (minutes, optional)</label>
              <input type="number" id="maxDuration" class="form-input" min="10" max="300" placeholder="120">
            </div>
            <button class="btn btn-primary" onclick="Views.submitCheckIn()">
              Get SentiraX picks
            </button>
            <div id="checkinError" class="error-text hidden"></div>
          </div>
        </div>
      `;
    },

    initCheckIn() {
      const slider = document.getElementById("moodSlider");
      const label = document.getElementById("moodLabel");
      const labels = {
        1:"Very low (1)",2:"Low (2)",3:"Drained (3)",4:"Below neutral (4)",
        5:"Neutral (5)",6:"Above neutral (6)",7:"Engaged (7)",8:"Hyped (8)",
        9:"Very hyped (9)",10:"Maxed out (10)"
      };
      slider.addEventListener("input", e => {
        label.textContent = labels[e.target.value] || `Mood ${e.target.value}`;
      });

      const moods = [
        "Chill","Sad","Happy","Stressed","Tired",
        "Romantic","Bored","Curious","Nostalgic","Anxious",
        "Energetic","Cozy","Adventurous","Dark","Silly"
      ];
      const moodContainer = document.getElementById("moodTags");
      moods.forEach(m => {
        const div = document.createElement("div");
        div.className = "mood-tag";
        div.dataset.value = m;
        div.textContent = m;
        div.onclick = () => div.classList.toggle("selected");
        moodContainer.appendChild(div);
      });
    },

    submitCheckIn() {
      if (!AppState.user) {
        Views.showModal("Profile needed", "Please finish onboarding so SentiraX knows your age and taste.");
        Router.navigate("onboarding");
        return;
      }

      const slider = document.getElementById("moodSlider");
      const moodScore = Number(slider.value || 5);
      const freeText = document.getElementById("freeText").value.trim();
      const typeFilter = document.getElementById("typeFilter").value;
      const maxDurationStr = document.getElementById("maxDuration").value;
      const maxDuration = maxDurationStr ? Number(maxDurationStr) : null;

      const moods = Array.from(document.querySelectorAll("#moodTags .mood-tag.selected"))
        .map(x => x.dataset.value);

      const checkIn = {
        moods,
        mood_score: moodScore,
        free_text: freeText,
        type_filter: typeFilter,
        max_duration_minutes: maxDuration
      };

      AppState.saveCheckIn(checkIn);
      Router.navigate("recommendations");
    },

    recommendations() {
      return `
        <div class="center-block">
          <h2 class="responsive-heading" style="margin-bottom:1rem;">SentiraX suggestions</h2>
          <p class="small-text" style="margin-bottom:1.4rem;">
            These will blend your baseline taste with how you‚Äôre feeling right now.
          </p>
          <div id="recsContainer">
            <div class="card">
              <div class="loading">
                <div class="spinner"></div>
                <p class="small-text">Thinking about your mood and browsing films...</p>
              </div>
            </div>
          </div>
          <button class="btn btn-secondary" style="margin-top:0.9rem;" onclick="Views.refreshRecommendations()">
            üîÑ New picks
          </button>
        </div>
      `;
    },

    async initRecommendations() {
      const c = document.getElementById("recsContainer");

      if (AppState.recommendations && AppState.recommendations.length) {
        Views.renderRecommendations(AppState.lastSummary, AppState.recommendations);
        return;
      }

      if (!AppState.user || !AppState.lastCheckIn) {
        c.innerHTML = `
          <div class="card">
            <p class="small-text">We‚Äôre missing either your profile or a mood check-in. Please do both first.</p>
            <div style="margin-top:.8rem;display:flex;flex-direction:column;gap:.5rem;">
              <button class="btn btn-primary" onclick="Router.navigate('onboarding')">Set up profile</button>
              <button class="btn btn-secondary" onclick="Router.navigate('check-in')">Do mood check-in</button>
            </div>
          </div>
        `;
        return;
      }

      await Views.fetchRecommendations();
    },

    async fetchRecommendations() {
      const c = document.getElementById("recsContainer");
      c.innerHTML = `
        <div class="card">
          <div class="loading">
            <div class="spinner"></div>
            <p class="small-text">Re-ranking titles for you...</p>
          </div>
        </div>
      `;

      try {
        const body = {
          user_profile: AppState.user,
          check_in: AppState.lastCheckIn
        };
        const res = await fetch(BACKEND_BASE_URL + "/api/recommend", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body)
        });
        const json = await res.json();

        if (!res.ok) {
          c.innerHTML = `
            <div class="card">
              <p class="small-text">Error from backend: ${res.status} ${res.statusText}</p>
              <p class="small-text">${(json && json.error) || ""}</p>
              <p class="small-text">${(json && json.details) || ""}</p>
              <button class="btn btn-secondary" style="margin-top:.8rem;" onclick="Views.fetchRecommendations()">Try again</button>
            </div>
          `;
          return;
        }

        AppState.recommendations = json.recommendations || [];
        AppState.lastSummary = json.high_level_summary || "";
        Views.renderRecommendations(json.high_level_summary, AppState.recommendations);
      } catch (e) {
        c.innerHTML = `
          <div class="card">
            <p class="small-text">Network error while getting recommendations.</p>
            <p class="small-text">${e.message || e}</p>
            <button class="btn btn-secondary" style="margin-top:.8rem;" onclick="Views.fetchRecommendations()">Try again</button>
          </div>
        `;
      }
    },

    renderRecommendations(summary, recs) {
      const c = document.getElementById("recsContainer");
      if (!recs || !recs.length) {
        c.innerHTML = `
          <div class="card">
            <p class="small-text">No suitable titles came back. Try broadening your mood / filters.</p>
          </div>
        `;
        return;
      }

      const summaryHtml = summary
        ? `<p class="small-text" style="margin-bottom:1rem;">${summary}</p>`
        : "";

      const itemsHtml = recs.map(r => {
        const name = r.name || r.title || "Untitled";
        const genres = (r.genres || []).slice(0, 3);
        const runtime = r.runtime_minutes ? `${r.runtime_minutes} min` : null;
        const type = r.type === "show" ? "Series" : "Movie";
        const year = r.release_year || r.year || null;
        const posterUrl = r.poster_path
          ? `https://image.tmdb.org/t/p/w342${r.poster_path}`
          : null;

        return `
  <div class="title-card" data-id="${r.id}">
    ${posterUrl ? `
      <img
        class="title-banner"
        src="${posterUrl}"
        alt="${name} poster"
        loading="lazy"
      />
    ` : ""}
    <div class="title-header">
      <div class="title-main">
        <div class="title-name">${name}</div>
        <div class="badge-row">
          <span class="badge badge-type">${type}</span>
          ${year ? `<span class="badge">${year}</span>` : ""}
          ${runtime ? `<span class="badge">${runtime}</span>` : ""}
          ${genres.map(g => `<span class="badge">${g}</span>`).join("")}
          ${r.is_adult ? `<span class="badge badge-18">18+</span>` : ""}
        </div>
      </div>
      <button class="btn-ghost watchlist-toggle" data-id="${r.id}" aria-label="Toggle watchlist">
        ‚≠ê
      </button>
    </div>
    ${r.summary ? `<p class="summary-text">${r.summary}</p>` : ""}
    ${r.reason ? `<p class="reason-text"><b>Why SentiraX picked this:</b> ${r.reason}</p>` : ""}
  </div>
        `;
      }).join("");

      c.innerHTML = `
  <div class="card">
    ${summaryHtml}
    ${itemsHtml}
  </div>
`;


      // detail navigation
      c.querySelectorAll(".title-card").forEach(card => {
        card.addEventListener("click", () => {
          const id = card.dataset.id;
          if (!id) return;
          const obj = AppState.recommendations.find(r => String(r.id) === String(id));
          if (!obj) return;
          AppState.selectedTitle = obj;
          Router.navigate("detail", { title: obj });
        });
      });

      // watchlist toggles
      c.querySelectorAll(".watchlist-toggle").forEach(btn => {
        btn.addEventListener("click", (e) => {
          e.stopPropagation();
          const id = btn.dataset.id;
          Views.toggleWatchlist(id);
        });
      });
    },

    refreshRecommendations() {
      AppState.recommendations = [];
      AppState.lastSummary = "";
      Views.fetchRecommendations();
    },

    toggleWatchlist(id) {
      const item =
        AppState.recommendations.find(r => r.id === id) ||
        AppState.watchlist.find(r => r.id === id);
      if (!item) return;
      const exists = AppState.watchlist.find(r => r.id === id);
      if (exists) {
        AppState.removeFromWatchlist(id);
        Views.showToast("Removed from watchlist");
      } else {
        AppState.addToWatchlist(item);
        Views.showToast("Added to watchlist");
      }
    },

    detail(title) {
      const name = title.name || title.title || "Untitled";
      const type = title.type === "show" ? "Series" : "Movie";
      const genres = (title.genres || []).join(", ");
      const runtime = title.runtime_minutes ? `${title.runtime_minutes} min` : null;
      const year = title.release_year || title.year || null;

      const posterUrl = title.poster_path
        ? `https://image.tmdb.org/t/p/w500${title.poster_path}`
        : null;

      return `
        <div class="center-block">
          <button class="btn-ghost" onclick="Router.navigate('recommendations')">‚Üê Back to picks</button>
          <div class="card" style="margin-top:1rem;">
            ${posterUrl ? `
              <img
                class="title-banner"
                src="${posterUrl}"
                alt="${name} poster"
                loading="lazy"
              />
            ` : ""}
            <div class="section-label">Title</div>
            <h2 class="responsive-heading" style="margin-bottom:.3rem;">${name}</h2>
            <p class="small-text" style="margin-bottom:.6rem;">
              ${type}
              ${year ? " ‚Ä¢ " + year : ""}
              ${genres ? " ‚Ä¢ " + genres : ""}
              ${runtime ? " ‚Ä¢ " + runtime : ""}
              ${title.is_adult ? ' ‚Ä¢ <span class="badge badge-18">18+</span>' : ""}
            </p>
            <p class="small-text" style="margin-top:.8rem;">
              ${title.summary || "Plot summary will appear once details load."}
            </p>
            ${title.reason ? `
              <div style="margin-top:1rem;">
                <div class="detail-section-title"><b>Why SentiraX picked this</b></div>
                <p class="small-text">${title.reason}</p>
              </div>
            ` : ""}
            <div style="margin-top:1rem;display:flex;gap:.6rem;flex-wrap:wrap;">
              <button class="btn btn-secondary" id="detailWatchlistBtn">
                ‚òÜ Add to watchlist
              </button>
              <button class="btn btn-secondary" id="wikiDetailsBtn">
                üìñ See full details (Wikipedia)
              </button>
            </div>
            <div id="detailMeta" style="margin-top:1rem;"></div>
            <div id="wikiDetailsContainer" style="margin-top:1rem;"></div>
          </div>
        </div>
      `;
    },

    async initDetail(title) {
      // Watchlist button
      Views.setupDetailWatchlist(title);

      // Wikipedia button
      const wikiBtn = document.getElementById("wikiDetailsBtn");
      if (wikiBtn) {
        wikiBtn.addEventListener("click", () => {
          Views.fetchWikiDetails(title);
        });
      }

      // TMDB meta (cast + providers)
      const container = document.getElementById("detailMeta");
      const cacheKey = `${title.type}-${title.tmdb_id}`;
      if (AppState.detailsCache[cacheKey]) {
        Views.renderDetailMeta(AppState.detailsCache[cacheKey], container, title);
        return;
      }

      container.innerHTML = `
        <div class="loading">
          <div class="spinner"></div>
          <p class="small-text">Loading cast and watch providers...</p>
        </div>
      `;

      try {
        const res = await fetch(BACKEND_BASE_URL + "/api/title-details", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ id: title.tmdb_id })
        });
        const json = await res.json();
        if (!res.ok) {
          container.innerHTML = `<p class="small-text">Could not load extra details.</p>`;
          return;
        }
        AppState.detailsCache[cacheKey] = json;
        Views.renderDetailMeta(json, container, title);
      } catch (e) {
        container.innerHTML = `<p class="small-text">Error loading details: ${e.message || e}</p>`;
      }
    },

    async fetchWikiDetails(title) {
      const btn = document.getElementById("wikiDetailsBtn");
      const container = document.getElementById("wikiDetailsContainer");
      if (!btn || !container) return;

      const name = title.name || title.title || "Untitled";
      const year = title.release_year || title.year || null;

      const originalLabel = btn.textContent;
      btn.disabled = true;
      btn.textContent = "Loading from Wikipedia...";

      container.innerHTML = `
        <div class="loading">
          <div class="spinner"></div>
          <p class="small-text">Pulling full details from Wikipedia...</p>
        </div>
      `;

      try {
        const res = await fetch(BACKEND_BASE_URL + "/api/wiki-full", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ title: name, year })
        });
        const data = await res.json();

        if (!res.ok || (!data.html && !data.summary)) {
          container.innerHTML = `
            <p class="small-text">Couldn‚Äôt load Wikipedia details for this title.</p>
          `;
          return;
        }

        const wikiTitle = data.title || data.wiki_title || name;
        const wikiHtml = data.html || `<p class="small-text">${data.summary || "No details available."}</p>`;
        const wikiUrl = data.url || null;

        // Build the preview area using DOM APIs to avoid escaping issues
        container.innerHTML = "";

        const heading = document.createElement("div");
        heading.className = "detail-section-title";
        heading.textContent = "From Wikipedia";
        container.appendChild(heading);

        const box = document.createElement("div");
        box.className = "small-text";
        box.style.maxHeight = "260px";
        box.style.overflow = "auto";
        box.style.border = "1px solid var(--border-subtle)";
        box.style.borderRadius = "10px";
        box.style.padding = "0.75rem";
        box.style.background = "#020617";
        box.innerHTML = wikiHtml;
        container.appendChild(box);

        // Fullscreen button
        const fullBtn = document.createElement("button");
        fullBtn.className = "btn btn-secondary";
        fullBtn.style.marginTop = "0.6rem";
        fullBtn.type = "button";
        fullBtn.textContent = "Expand";
        fullBtn.addEventListener("click", () => {
          Views.openWikiFullscreen(wikiTitle, wikiHtml, wikiUrl);
        });
        container.appendChild(fullBtn);
      } catch (e) {
        container.innerHTML = `
          <p class="small-text">Error loading Wikipedia details: ${e.message || e}</p>
        `;
      } finally {
        btn.disabled = false;
        btn.textContent = originalLabel;
      }
    },

    setupDetailWatchlist(title) {
      const btn = document.getElementById("detailWatchlistBtn");
      if (!btn) return;

      const updateLabel = () => {
        const inList = AppState.watchlist.some(item => item.id === title.id);
        btn.textContent = inList ? "‚≠ê In watchlist" : "‚òÜ Add to watchlist";
      };

      updateLabel();

      btn.onclick = () => {
        const inList = AppState.watchlist.some(item => item.id === title.id);
        if (inList) {
          AppState.removeFromWatchlist(title.id);
          Views.showToast("Removed from watchlist");
        } else {
          AppState.addToWatchlist(title);
          Views.showToast("Added to watchlist");
        }
        updateLabel();
      };
    },

    renderDetailMeta(details, container, titleObj) {
      const cast = details.cast || [];
      const wp = details.watch_providers || {};
      const groups = [
        { key: "flatrate", label: "Streaming" },
        { key: "rent",     label: "Rent" },
        { key: "buy",      label: "Buy" }
      ];

      const titleName =
        (titleObj && (titleObj.name || titleObj.title)) ||
        "this title";

      let castHtml = "";
      if (cast.length) {
        castHtml = `
          <div class="detail-section-title">Cast</div>
          <ul class="cast-list">
            ${cast.slice(0, 8).map(c => `
              <li>${c.name}${c.character ? " as " + c.character : ""}</li>
            `).join("")}
          </ul>
        `;
      }

      let providersHtml = "";
      const groupBlocks = groups.map(g => {
        const list = wp[g.key] || [];
        if (!list.length) return "";

        const names = list.map((p, idx) => {
          const url =
            p.url || Views.buildProviderUrl(p.provider_name, titleName);

          const comma = idx < list.length - 1 ? ", " : "";
          return `
            <a
              class="provider-name"
              href="${url}"
              target="_blank"
              rel="noopener noreferrer"
            >${p.provider_name}</a>${comma}
          `;
        }).join("");

        return `
          <div class="provider-group">
            <div class="provider-group-title">${g.label}</div>
            <div>${names}</div>
          </div>
        `;
      }).filter(Boolean).join("");

      if (groupBlocks) {
        providersHtml = `
          <div class="detail-section-title">Where TMDB says it‚Äôs available</div>
          <div class="providers-groups">${groupBlocks}</div>
          <p class="small-text" style="margin-top:.4rem;">
            Availability is region-dependent and can change. Check directly in your preferred streaming app to confirm.
          </p>
        `;
      }

      const watchOnHtml = titleName ? Views.renderWatchOnLinks(titleName) : "";

      container.innerHTML = `
        ${castHtml}
        ${providersHtml}
        ${watchOnHtml}
      `;
    },

    buildProviderUrl(providerName, title) {
      const q = encodeURIComponent(`${title} ${providerName} watch`);
      const name = providerName.toLowerCase();

      if (name.includes("netflix")) {
        return `https://www.netflix.com/search?q=${encodeURIComponent(title)}`;
      }
      if (name.includes("prime") || name.includes("amazon")) {
        return `https://www.primevideo.com/search?phrase=${encodeURIComponent(title)}`;
      }
      if (name.includes("disney")) {
        return `https://www.disneyplus.com/search/${encodeURIComponent(title)}`;
      }
      if (name.includes("apple")) {
        return `https://tv.apple.com/search?term=${encodeURIComponent(title)}`;
      }
      if (name.includes("hulu")) {
        return `https://www.hulu.com/search?q=${encodeURIComponent(title)}`;
      }

      return `https://www.google.com/search?q=${q}`;
    },

    buildServiceSearchUrl(serviceName, title) {
      const lower = serviceName.toLowerCase();
      const encodedTitle = encodeURIComponent(title);
      const slugTitle = title.trim().replace(/\s+/g, "-");

      if (lower.includes("tubi")) {
        return `https://tubitv.com/search/${encodedTitle}`;
      } else if (lower.includes("pluto")) {
        return `https://pluto.tv/us/search?query=${encodedTitle}`;
      } else if (lower.includes("crackle")) {
        return `https://www.crackle.com/search?query=${encodedTitle}`;
      } else if (lower.includes("roku")) {
        return `https://therokuchannel.roku.com/search?q=${encodedTitle}`;
      } else if (lower.includes("freevee")) {
        return `https://www.amazon.com/s?k=${encodedTitle}&i=instant-video`;
      } else if (lower.includes("uflix")) {
        return `https://uflix.cc/search?keyword=${encodedTitle}`;
      } else if (lower.includes("soap2day")) {
        return `https://ww25.soap2day.day/?s=${encodedTitle}`;
      } else if (lower.includes("netmirror")) {
        return `https://www.google.com/search?q=NetMirror+App`;
      } else if (lower.includes("cineb")) {
        return `https://cineb.gg/search/${slugTitle}`;
      } else if (lower.includes("lookmovie")) {
        return `https://www.google.com/search?q=LookMovie`;
      } else if (lower.includes("fmovies")) {
        return `https://ww4.fmovies.co/search/?q=${encodedTitle}`;
      } else if (lower.includes("123movies")) {
        return `https://ww7.123moviesfree.net/search/?q=${encodedTitle}`;
      } else if (lower.includes("yesmovies")) {
        return `https://moviejabber.org/search/?s=${encodedTitle}`;
      } else if (lower.includes("flixtor")) {
        return `https://flixtor.studio/?s=${encodedTitle}`;
      }

      return `https://www.google.com/search?q=${encodeURIComponent(
        `${title} on ${serviceName}`
      )}`;
    },

    renderWatchOnLinks(titleName) {
      const services = [
        "Tubi",
        "Pluto TV",
        "Crackle",
        "Roku Channel",
        "Freevee",
        "Uflix",
        "Soap2Day",
        "NetMirror",
        "Cineb.net",
        "FMovies",
        "123Movies",
        "LookMovie",
        "YesMovies",
        "FlixTor"
      ];

      const links = services.map(service => {
        const url = Views.buildServiceSearchUrl(service, titleName);
        return `
          <a
            class="stream-btn"
            href="${url}"
            target="_blank"
            rel="noopener noreferrer"
          >
            ${service}
          </a>
        `;
      }).join("");

      return `
        <div class="detail-section-title" style="margin-top:.9rem;">Search on</div>
        <div class="stream-row">
          ${links}
        </div>
      `;
    },

    watchlist() {
      const list = AppState.watchlist;
      if (!list.length) {
        return `
          <div class="center-block" style="text-align:center;padding:2.4rem 0;">
            <div style="font-size:3rem;margin-bottom:.7rem;">üì∫</div>
            <h2 class="responsive-heading" style="margin-bottom:.6rem;">Your watchlist is empty</h2>
            <p class="small-text" style="margin-bottom:1.4rem;">Add shows and movies from your SentiraX picks to keep track of what you want to watch.</p>
            <button class="btn btn-primary" onclick="Router.navigate('recommendations')">Go to Discover</button>
          </div>
        `;
      }

      const items = list.map(r => {
        const name = r.name || r.title || "Untitled";
        const type = r.type === "show" ? "Series" : "Movie";
        const genresStr = (r.genres || []).slice(0, 3).join(", ");
        const runtime = r.runtime_minutes ? `${r.runtime_minutes} min` : "";
        const year = r.release_year || r.year || "";

        return `
          <div class="title-card" data-id="${r.id}">
            <div class="title-header">
              <div class="title-main">
                <div class="title-name">${name}</div>
                <div class="badge-row">
                  <span class="badge badge-type">${type}</span>
                  ${year ? `<span class="badge">${year}</span>` : ""}
                  ${runtime ? `<span class="badge">${runtime}</span>` : ""}
                  ${genresStr ? `<span class="badge">${genresStr}</span>` : ""}
                </div>
              </div>
              <button class="btn-ghost watchlist-remove" data-id="${r.id}" aria-label="Remove from watchlist">
                üóëÔ∏è
              </button>
            </div>
            ${r.summary ? `<p class="summary-text">${r.summary}</p>` : ""}
          </div>
        `;
      }).join("");

      return `
        <div class="center-block">
          <h2 class="responsive-heading" style="margin-bottom:1rem;">My watchlist</h2>
          <div class="card">
            ${items}
          </div>
        </div>
      `;
    },

    initWatchlist() {
      document.querySelectorAll(".title-card").forEach(card => {
        card.addEventListener("click", () => {
          const id = card.dataset.id;
          if (!id) return;
          const obj =
            AppState.watchlist.find(r => String(r.id) === String(id)) ||
            AppState.recommendations.find(r => String(r.id) === String(id));
          if (!obj) return;
          AppState.selectedTitle = obj;
          Router.navigate("detail", { title: obj });
        });
      });

      document.querySelectorAll(".watchlist-remove").forEach(btn => {
        btn.addEventListener("click", (e) => {
          e.stopPropagation();
          const id = btn.dataset.id;
          Views.removeFromWatchlist(id);
        });
      });
    },

    removeFromWatchlist(id) {
      AppState.removeFromWatchlist(id);
      Views.showToast("Removed from watchlist");
      Router.navigate("watchlist");
    },

    settings() {
      const user = AppState.user;
      return `
        <div class="center-block">
          <h2 class="responsive-heading" style="margin-bottom:1.1rem;">Settings</h2>
          <div class="card">
            <div class="section-label">Profile</div>
            ${user ? `
              <p class="small-text"><strong>Age:</strong> ${user.age}</p>
              <p class="small-text"><strong>Gender:</strong> ${user.gender || "Not set"}</p>
              <p class="small-text"><strong>Liked genres:</strong> ${(user.liked_genres || []).join(", ") || "None set"}</p>
              <p class="small-text"><strong>Disliked genres:</strong> ${(user.disliked_genres || []).join(", ") || "None set"}</p>
              <p class="small-text"><strong>Goals:</strong> ${(user.goals || []).join(", ") || "None set"}</p>
              <p class="small-text"><strong>Allow 18+:</strong> ${user.allow_adult ? "Yes (18+)" : "No"}</p>
            ` : `<p class="small-text">No profile yet. Complete onboarding to set one.</p>`}
          </div>
          <div class="card">
            <div class="section-label">Usage</div>
            <p class="small-text"><strong>Mood check-ins:</strong> ${AppState.checkins.length}</p>
            <p class="small-text"><strong>Watchlist items:</strong> ${AppState.watchlist.length}</p>
          </div>
          <div class="card">
            <div class="section-label">Data</div>
            <p class="small-text" style="margin-bottom:0.8rem;">
              Your profile and history are stored locally in this browser and sent to the backend only for generating recommendations. You can clear everything anytime.
            </p>
            <button class="btn btn-secondary" style="margin-bottom:0.6rem;" onclick="Views.clearHistory()">Clear history</button>
            <button class="btn btn-secondary" onclick="Views.resetApp()">Reset all & start over</button>
          </div>
        </div>
      `;
    },

    clearHistory() {
      AppState.checkins = [];
      Storage.set("checkins", []);
      Views.showToast("History cleared");
      Router.navigate("settings");
    },

    resetApp() {
      Views.showConfirm(
        "Reset SentiraX?",
        "This clears your profile, watchlist, and mood history.",
        () => {
          AppState.reset();
          Router.navigate("welcome");
        }
      );
    },

    showModal(title, message) {
      const overlay = document.createElement("div");
      overlay.className = "modal-overlay";
      overlay.innerHTML = `
        <div class="modal-content">
          <h3 style="margin-bottom:.6rem;">${title}</h3>
          <p class="small-text" style="margin-bottom:1rem;">${message}</p>
          <button class="btn btn-primary" style="width:100%;" onclick="this.closest('.modal-overlay').remove()">OK</button>
        </div>
      `;
      document.body.appendChild(overlay);
    },

    showConfirm(title, message, onConfirm) {
      const overlay = document.createElement("div");
      overlay.className = "modal-overlay";
      overlay.innerHTML = `
        <div class="modal-content">
          <h3 style="margin-bottom:.6rem;">${title}</h3>
          <p class="small-text" style="margin-bottom:1rem;">${message}</p>
          <div style="display:flex;gap:.5rem;flex-wrap:wrap;">
            <button class="btn btn-secondary" style="flex:1;" data-role="cancel">Cancel</button>
            <button class="btn btn-primary" style="flex:1;" data-role="ok">Confirm</button>
          </div>
        </div>
      `;
      document.body.appendChild(overlay);
      overlay.querySelector('[data-role="cancel"]').onclick = () => overlay.remove();
      overlay.querySelector('[data-role="ok"]').onclick = () => {
        overlay.remove();
        if (typeof onConfirm === "function") onConfirm();
      };
    },

    showToast(msg) {
      const existing = document.getElementById("sentirax_toast");
      if (existing) existing.remove();
      const el = document.createElement("div");
      el.id = "sentirax_toast";
      el.style.position = "fixed";
      el.style.bottom = "80px";
      el.style.left = "50%";
      el.style.transform = "translateX(-50%)";
      el.style.background = "#020617";
      el.style.color = "#e5e7eb";
      el.style.border = "1px solid #22c55e55";
      el.style.borderRadius = "999px";
      el.style.padding = "0.45rem 0.9rem";
      el.style.fontSize = "0.8rem";
      el.style.boxShadow = "0 18px 40px rgba(0,0,0,0.9)";
      el.style.zIndex = "60";
      el.textContent = msg;
      document.body.appendChild(el);
      setTimeout(() => {
        el.style.transition = "opacity .3s ease";
        el.style.opacity = "0";
        setTimeout(() => el.remove(), 300);
      }, 1500);
    },

    // ---------- Wikipedia fullscreen nav ----------

    renderWikiFullscreenCurrent() {
      const entry = Views._wikiHistory[Views._wikiHistoryIndex];
      if (!entry) return;

      const titleEl = document.getElementById("wikiFullscreenTitle");
      const textEl  = document.getElementById("wikiFullscreenText");

      if (titleEl) titleEl.textContent = entry.title || "Wikipedia";
      if (textEl) {
        textEl.innerHTML = entry.html || "<p class='small-text'>No content available.</p>";
        Views.hijackWikipediaLinks(textEl);
      }

      const backBtn = document.getElementById("wikiNavBack");
      const fwdBtn  = document.getElementById("wikiNavForward");
      if (backBtn) backBtn.disabled = Views._wikiHistoryIndex <= 0;
      if (fwdBtn)  fwdBtn.disabled  = Views._wikiHistoryIndex >= Views._wikiHistory.length - 1;
    },

    wikiGoBack() {
      if (Views._wikiHistoryIndex > 0) {
        Views._wikiHistoryIndex--;
        Views.renderWikiFullscreenCurrent();
      }
    },

    wikiGoForward() {
      if (Views._wikiHistoryIndex < Views._wikiHistory.length - 1) {
        Views._wikiHistoryIndex++;
        Views.renderWikiFullscreenCurrent();
      }
    },

    openWikiFullscreen(title, html /*, url */) {
      Views._wikiHistory = [
        {
          title: title || "Wikipedia",
          html: html || "<p class='small-text'>No content available.</p>"
        }
      ];
      Views._wikiHistoryIndex = 0;

      Views.renderWikiFullscreenCurrent();

      const modal = document.getElementById("wikiFullscreen");
      if (modal) modal.classList.remove("hidden");

      const backBtn = document.getElementById("wikiNavBack");
      const fwdBtn  = document.getElementById("wikiNavForward");

      if (backBtn) backBtn.onclick = () => Views.wikiGoBack();
      if (fwdBtn)  fwdBtn.onclick  = () => Views.wikiGoForward();
    },

    closeWikiFullscreen() {
      const modal = document.getElementById("wikiFullscreen");
      if (modal) modal.classList.add("hidden");
    },

    hijackWikipediaLinks(container) {
      if (!container) return;
      if (container._wikiHandlerAttached) return;
      container._wikiHandlerAttached = true;

      container.addEventListener("click", async (e) => {
        const link = e.target.closest("a");
        if (!link) return;

        const hrefAttr = link.getAttribute("href");
        if (!hrefAttr) return;

        if (!hrefAttr.includes("/wiki/")) {
          return;
        }

        e.preventDefault();

        let pageTitle = null;
        try {
          const url = new URL(hrefAttr, window.location.origin);
          const path = url.pathname;
          const slug = path.substring(path.lastIndexOf("/") + 1);
          pageTitle = decodeURIComponent(slug.replace(/_/g, " "));
        } catch {
          pageTitle = hrefAttr;
        }

        if (!pageTitle) return;

        const textEl  = document.getElementById("wikiFullscreenText");
        if (textEl) {
          textEl.innerHTML = `
            <div class="loading">
              <div class="spinner"></div>
              <p class="small-text">Loading Wikipedia page: ${pageTitle}...</p>
            </div>
          `;
        }

        try {
          const res = await fetch(BACKEND_BASE_URL + "/api/wiki-full", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ title: pageTitle })
          });

          const data = await res.json();

          if (!res.ok || !data.html) {
            if (textEl) {
              textEl.innerHTML = `<p class="small-text">Could not load Wikipedia page "${pageTitle}".</p>`;
            }
            return;
          }

          const newTitle = data.title || data.wiki_title || pageTitle;
          const newHtml  = data.html || "<p class='small-text'>No content available.</p>";

          if (Views._wikiHistoryIndex < Views._wikiHistory.length - 1) {
            Views._wikiHistory = Views._wikiHistory.slice(0, Views._wikiHistoryIndex + 1);
          }

          Views._wikiHistory.push({
            title: newTitle,
            html:  newHtml
          });
          Views._wikiHistoryIndex = Views._wikiHistory.length - 1;

          Views.renderWikiFullscreenCurrent();
        } catch (err) {
          if (textEl) {
            textEl.innerHTML = `<p class="small-text">Error loading Wikipedia page: ${err.message || err}</p>`;
          }
        }
      });
    }
  };

  // Initial boot
  document.addEventListener("DOMContentLoaded", () => {
    document.querySelectorAll(".nav-item").forEach(item => {
      item.addEventListener("click", () => {
        Router.navigate(item.dataset.view);
      });
    });
    AppState.init();
    Router.navigate(AppState.currentView);
  });

  // PWA service worker
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => {
      navigator.serviceWorker
        .register("./service-worker.js")
        .catch(() => {});
    });
  }

  // PWA install prompt handling
  let deferredInstallPrompt = null;

  window.addEventListener("beforeinstallprompt", (e) => {
    e.preventDefault();
    deferredInstallPrompt = e;

    const btn = document.getElementById("installPwaBtn");
    if (btn) btn.classList.remove("hidden");
  });

  document.addEventListener("DOMContentLoaded", () => {
    const btn = document.getElementById("installPwaBtn");
    if (!btn) return;

    btn.addEventListener("click", async () => {
      if (!deferredInstallPrompt) return;

      deferredInstallPrompt.prompt();
      const outcome = await deferredInstallPrompt.userChoice;

      if (outcome.outcome) {
        btn.classList.add("hidden");
      }
      deferredInstallPrompt = null;
    });
  });
    
    //===COOKIES===
    document.addEventListener("DOMContentLoaded", function () {
    const CONSENT_KEY = "sentirax_cookie_consent";

    const banner = document.getElementById("cookie-banner");
    const acceptBtn = document.getElementById("cookie-accept-btn");
    const rejectBtn = document.getElementById("cookie-reject-btn");
    const settingsBtn = document.getElementById("cookie-settings-btn");

    const modal = document.getElementById("cookie-modal");
    const saveBtn = document.getElementById("cookie-save-btn");
    const cancelBtn = document.getElementById("cookie-cancel-btn");

    const analyticsBox = document.getElementById("analyticsCookies");
    const adsBox = document.getElementById("adCookies");

    const saved = JSON.parse(localStorage.getItem(CONSENT_KEY) || "{}");

    if (!saved.choice) {
      banner.classList.remove("hidden");
    }

    acceptBtn.addEventListener("click", () => {
      localStorage.setItem(CONSENT_KEY, JSON.stringify({
        choice: "accepted",
        analytics: true,
        ads: true
      }));
      banner.classList.add("hidden");
    });

    rejectBtn.addEventListener("click", () => {
      localStorage.setItem(CONSENT_KEY, JSON.stringify({
        choice: "rejected",
        analytics: false,
        ads: false
      }));
      banner.classList.add("hidden");
    });

    settingsBtn.addEventListener("click", () => {
      analyticsBox.checked = !!saved.analytics;
      adsBox.checked = !!saved.ads;
      modal.classList.remove("hidden");
    });

    saveBtn.addEventListener("click", () => {
      localStorage.setItem(CONSENT_KEY, JSON.stringify({
        choice: "custom",
        analytics: analyticsBox.checked,
        ads: adsBox.checked
      }));
      modal.classList.add("hidden");
    });

    cancelBtn.addEventListener("click", () => {
      modal.classList.add("hidden");
    });
});

    
</script>

  
  <!-- Fullscreen Wikipedia modal -->
<div id="wikiFullscreen" class="modal-overlay hidden">
  <div class="modal-content" style="max-width: 900px; width: 100%; max-height: 90vh; overflow: hidden; display:flex; flex-direction:column;">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:.4rem;">
  <h3 id="wikiFullscreenTitle" style="margin:0;font-size:1.05rem;font-weight:500;"></h3>

  <div style="display:flex;align-items:center;gap:.4rem;" class="wiki-fullscreen-controls">
    <button
    id="wikiNavBack"
    class="wiki-nav-btn"
    aria-label="Back"
    disabled
  >
    <svg viewBox="0 0 24 24" aria-hidden="true">
      <!-- Material-style left chevron -->
      <path d="M15.41 7.41 14 6 8 12l6 6 1.41-1.41L10.83 12z"></path>
    </svg>
  </button>

  <button
    id="wikiNavForward"
    class="wiki-nav-btn"
    aria-label="Forward"
    disabled
  >
    <svg viewBox="0 0 24 24" aria-hidden="true">
      <!-- Material-style right chevron -->
      <path d="M8.59 16.59 10 18l6-6-6-6-1.41 1.41L13.17 12z"></path>
    </svg>
  </button>

  <button
    class="wiki-close-btn"
    aria-label="Close"
    onclick="Views.closeWikiFullscreen()"
  >
    ‚úï
  </button>
  </div>
</div>
    <div id="wikiFullscreenText" style="flex:1;overflow:auto;border:1px solid var(--border-subtle);border-radius:10px;padding:0.75rem;background:#020617;font-size:0.85rem;"></div>
  </div>
</div>

  
  <div id="cookie-banner" class="card hidden" 
     style="position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            max-width: 520px; width: 90%; z-index: 9999;">

  <p class="small-text" style="margin-bottom: .8rem;">
    We use cookies to improve your experience and show personalized ads. 
    You can accept, reject, or customize your choices.
  </p>

  <div style="display:flex;gap:.6rem;flex-wrap:wrap;">
    <button id="cookie-accept-btn" class="btn btn-primary" style="flex:1;">Accept</button>
    <button id="cookie-reject-btn" class="btn btn-secondary" style="flex:1;">Reject</button>
    <button id="cookie-settings-btn" class="btn btn-secondary" style="flex:1;">Settings</button>
  </div>
</div>

  <div id="cookie-modal" class="modal-overlay hidden">
  <div class="modal-content" style="max-width: 480px; width: 95%;">
    <h3 style="margin-bottom: .8rem;">Cookie Preferences</h3>

    <p class="small-text">
      Choose which types of cookies you want to allow. You can change this anytime.
    </p>

    <div style="margin-top:1rem;">
      <label style="display:flex;align-items:center;gap:.6rem;">
        <input type="checkbox" id="analyticsCookies">
        <span>Allow Analytics Cookies</span>
      </label>

      <label style="display:flex;align-items:center;gap:.6rem;margin-top:.6rem;">
        <input type="checkbox" id="adCookies">
        <span>Allow Personalized Ads</span>
      </label>
    </div>

    <div style="margin-top:1.3rem;display:flex;gap:.7rem;">
      <button id="cookie-cancel-btn" class="btn btn-secondary" style="flex:1;">Cancel</button>
      <button id="cookie-save-btn" class="btn btn-primary" style="flex:1;">Save</button>
    </div>
  </div>
</div>



</body>
</html>
