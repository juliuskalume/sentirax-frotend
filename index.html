<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>SentiraX</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #020617;
      color: #e5e7eb;
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
    }
    .container {
      max-width: 800px;
      width: 100%;
      padding: 24px 16px 64px;
    }
    h1, h2, h3, h4 {
      color: #f9fafb;
      margin-top: 0;
    }
    .brand {
      font-weight: 700;
      font-size: 1.8rem;
      letter-spacing: 0.04em;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    .brand-pill {
      font-size: 0.75rem;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid #22c55e33;
      background: #022c22;
      color: #a7f3d0;
    }
    .tagline {
      font-size: 0.85rem;
      color: #9ca3af;
      margin-bottom: 18px;
    }
    .card {
      background: radial-gradient(circle at top left, #0f172a, #020617 55%);
      border-radius: 16px;
      padding: 16px 18px 20px;
      margin-bottom: 20px;
      border: 1px solid #1f2937;
      box-shadow: 0 18px 45px rgba(0,0,0,0.5);
    }
    .field {
      margin-bottom: 12px;
    }
    label {
      display: block;
      font-size: 0.85rem;
      margin-bottom: 4px;
      color: #9ca3af;
    }
    input[type="number"],
    select,
    textarea {
      width: 100%;
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid #4b5563;
      background: #020617;
      color: #e5e7eb;
      font-size: 0.9rem;
      box-sizing: border-box;
    }
    input[type="number"]:focus,
    select:focus,
    textarea:focus {
      outline: none;
      border-color: #22c55e;
      box-shadow: 0 0 0 1px #22c55e40;
    }
    textarea {
      min-height: 70px;
      resize: vertical;
    }
    .chips {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }
    .chip {
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid #4b5563;
      font-size: 0.8rem;
      cursor: pointer;
      user-select: none;
      background: #020617;
      transition: background 0.12s ease, border-color 0.12s ease, transform 0.05s ease;
    }
    .chip:hover {
      border-color: #6b7280;
      transform: translateY(-1px);
    }
    .chip.selected {
      background: linear-gradient(135deg, #22c55e, #22d3ee);
      border-color: #4ade80;
      color: #022c22;
    }
    button {
      padding: 8px 14px;
      border-radius: 999px;
      border: none;
      background: linear-gradient(135deg, #22c55e, #22d3ee);
      color: #022c22;
      font-weight: 600;
      font-size: 0.85rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      box-shadow: 0 10px 25px rgba(34, 197, 94, 0.25);
    }
    button.main {
      margin-top: 6px;
      font-size: 0.9rem;
      padding: 10px 16px;
    }
    button:disabled {
      opacity: 0.5;
      cursor: default;
      box-shadow: none;
    }
    button:hover:not(:disabled) {
      transform: translateY(-1px);
    }
    .stream-btn {
      display: inline-flex;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid #1f2937;
      font-size: 0.75rem;
      text-decoration: none;
      background: #020617;
      color: #e5e7eb;
      margin-right: 4px;
      margin-top: 4px;
    }
    .stream-btn:hover {
      border-color: #4ade80;
    }
    .small {
      font-size: 0.8rem;
      color: #9ca3af;
    }
    .toggle-row {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .checkbox {
      transform: scale(1.05);
    }
    .recommendation {
      border-top: 1px solid #1f2937;
      padding-top: 10px;
      margin-top: 10px;
    }
    .rec-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
    }
    .badge {
      display: inline-flex;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 0.7rem;
      background: #111827;
      border: 1px solid #374151;
      margin-right: 4px;
      margin-bottom: 3px;
    }
    .badge-18 {
      background: #450a0a;
      border-color: #b91c1c;
      color: #fecaca;
    }
    .error {
      color: #fecaca;
      font-size: 0.8rem;
      margin-top: 4px;
    }
    .hidden {
      display: none;
    }
    .section-label {
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: #6b7280;
      margin-bottom: 6px;
    }
    .detail-section-title {
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: #9ca3af;
      margin-top: 8px;
      margin-bottom: 4px;
    }
    ul.cast-list {
      list-style: none;
      padding-left: 0;
      margin: 0;
    }
    ul.cast-list li {
      font-size: 0.8rem;
      color: #d1d5db;
      margin-bottom: 2px;
    }
    .providers-groups {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 4px;
    }
    .provider-group {
      border-radius: 8px;
      border: 1px solid #1f2937;
      padding: 6px 8px;
      background: #020617;
    }
    .provider-group-title {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: #9ca3af;
      margin-bottom: 2px;
    }
    .provider-name {
      font-size: 0.8rem;
      color: #e5e7eb;
    }
    .stream-row {
      margin-top: 6px;
    }
    @media (max-width: 600px) {
      .container {
        padding-inline: 12px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div style="margin-bottom: 12px;">
      <div class="brand">
        SentiraX
        <span class="brand-pill">mood-aware picks</span>
      </div>
      <p class="tagline">
        Tell SentiraX your current vibe and it’ll hunt down movies and shows that match how you feel — including 18+ titles if you’re of age and opt in.
      </p>
    </div>

    <!-- Onboarding card -->
    <div id="onboarding-card" class="card">
      <div class="section-label">Step 1</div>
      <h2>Help SentiraX understand you</h2>

      <div class="field">
        <label for="age">Age <span style="color:#f97316;">*</span></label>
        <input type="number" id="age" min="13" max="120" placeholder="21" />
        <div id="age-error" class="error hidden">Please enter a valid age (13+).</div>
      </div>

      <div class="field">
        <label for="gender">Gender (optional)</label>
        <select id="gender">
          <option value="">Prefer not to say</option>
          <option value="female">Female</option>
          <option value="male">Male</option>
          <option value="non-binary">Non-binary</option>
          <option value="other">Other</option>
        </select>
      </div>

      <div class="field">
        <label>Genres you enjoy (optional)</label>
        <div id="liked-genres" class="chips"></div>
      </div>

      <div class="field">
        <label>Genres to avoid (optional)</label>
        <div id="disliked-genres" class="chips"></div>
      </div>

      <div class="field">
        <label>Your usual goals (optional)</label>
        <div id="goals" class="chips"></div>
      </div>

      <div class="field">
        <div class="toggle-row">
          <input class="checkbox" type="checkbox" id="allow-adult" />
          <label for="allow-adult" style="margin: 0;">Allow 18+ content (adult films)</label>
        </div>
        <p class="small">Only available if you’re 18+. You can change this later.</p>
      </div>

      <button class="main" id="save-profile-btn">Continue to mood check-in →</button>
      <div id="profile-status" class="small"></div>
    </div>

    <!-- Check-in card -->
    <div id="checkin-card" class="card hidden">
      <div class="section-label">Step 2</div>
      <h2>What’s your vibe right now?</h2>

      <div class="field">
        <label>Mood (optional)</label>
        <div id="mood-chips" class="chips"></div>
      </div>

      <div class="field">
        <label for="free-text">What’s on your mind / what do you feel like watching?</label>
        <textarea id="free-text" placeholder="e.g. I want something cozy and romantic, not too serious..."></textarea>
        <p class="small">
          You can be specific: “dark psychological thriller”, “short anime, chill vibe”, “background show while I study”, etc.
        </p>
      </div>

      <div class="field">
        <label>Type (optional)</label>
        <select id="type-filter">
          <option value="any">Movies or Shows</option>
          <option value="movie">Movies only</option>
          <option value="show">Shows only</option>
        </select>
      </div>

      <div class="field">
        <label for="max-duration">Max duration in minutes (optional)</label>
        <input type="number" id="max-duration" min="10" max="300" placeholder="120" />
      </div>

      <button class="main" id="get-recs-btn">Get SentiraX picks</button>
      <div id="loading" class="small hidden">Thinking about your mood and options...</div>
      <div id="checkin-error" class="error hidden"></div>

      <div id="recommendations-card" class="card hidden" style="margin-top:16px;">
        <h3>Your SentiraX suggestions</h3>
        <p id="summary" class="small"></p>
        <div id="recommendations-list"></div>
      </div>

      <div id="details-card" class="card hidden" style="margin-top:16px;">
        <h3 id="details-title">Details</h3>
        <p id="details-overview" class="small"></p>
        <p id="details-meta" class="small"></p>

        <div id="details-cast-section" class="hidden">
          <div class="detail-section-title">Cast</div>
          <ul id="details-cast" class="cast-list"></ul>
        </div>

        <div id="details-watch-section" class="hidden">
          <div class="detail-section-title">Where to watch</div>
          <div id="details-watch" class="providers-groups"></div>
          <p class="small" style="margin-top:4px;">Availability and region data via TMDB; may vary by location.</p>
        </div>
      </div>
    </div>
  </div>

  <script>
    const RENDER_BACKEND_URL = "https://sentirax-backend.onrender.com";

    function getApiBase() {
      if (location.hostname === "localhost" || location.hostname === "127.0.0.1") {
        return "http://localhost:3000";
      }
      return RENDER_BACKEND_URL;
    }

    const GENRES = [
      "Action", "Comedy", "Drama", "Romance", "Horror",
      "Thriller", "Sci-Fi", "Fantasy", "Anime", "Documentary",
      "Crime", "Mystery", "Adventure"
    ];

    const GOALS = [
      "Escape and relax",
      "Laugh",
      "Get inspired",
      "Learn something",
      "Background noise",
      "Watch with friends",
      "Date night"
    ];

    const MOODS = [
      "Happy", "Sad", "Stressed", "Tired", "Bored",
      "Angry", "Romantic", "Curious", "Motivated", "Neutral"
    ];

    function createChipGroup(containerId, values, multi = true) {
      const container = document.getElementById(containerId);
      container.innerHTML = "";
      values.forEach(value => {
        const div = document.createElement("div");
        div.className = "chip";
        div.textContent = value;
        div.dataset.value = value;
        div.addEventListener("click", () => {
          if (!multi) {
            container.querySelectorAll(".chip").forEach(ch => ch.classList.remove("selected"));
            div.classList.add("selected");
          } else {
            div.classList.toggle("selected");
          }
        });
        container.appendChild(div);
      });
    }

    function getSelectedValues(containerId) {
      return Array.from(document.querySelectorAll(`#${containerId} .chip.selected`))
        .map(ch => ch.dataset.value);
    }

    function saveProfileToStorage(profile) {
      localStorage.setItem("sentirax_profile", JSON.stringify(profile));
    }

    function loadProfileFromStorage() {
      const str = localStorage.getItem("sentirax_profile");
      if (!str) return null;
      try { return JSON.parse(str); } catch { return null; }
    }

    function showCheckinCard() {
      document.getElementById("onboarding-card").classList.add("hidden");
      document.getElementById("checkin-card").classList.remove("hidden");
    }

    function showOnboardingCard() {
      document.getElementById("onboarding-card").classList.remove("hidden");
      document.getElementById("checkin-card").classList.add("hidden");
    }

    createChipGroup("liked-genres", GENRES);
    createChipGroup("disliked-genres", GENRES);
    createChipGroup("goals", GOALS);
    createChipGroup("mood-chips", MOODS);

    const ageInput = document.getElementById("age");
    const genderSelect = document.getElementById("gender");
    const allowAdultCheckbox = document.getElementById("allow-adult");
    const profileStatus = document.getElementById("profile-status");
    const ageError = document.getElementById("age-error");

    const existingProfile = loadProfileFromStorage();
    if (existingProfile) {
      ageInput.value = existingProfile.age;
      genderSelect.value = existingProfile.gender || "";
      existingProfile.liked_genres?.forEach(g => {
        const chip = document.querySelector(`#liked-genres .chip[data-value="${g}"]`);
        if (chip) chip.classList.add("selected");
      });
      existingProfile.disliked_genres?.forEach(g => {
        const chip = document.querySelector(`#disliked-genres .chip[data-value="${g}"]`);
        if (chip) chip.classList.add("selected");
      });
      existingProfile.goals?.forEach(g => {
        const chip = document.querySelector(`#goals .chip[data-value="${g}"]`);
        if (chip) chip.classList.add("selected");
      });
      if (existingProfile.allow_adult) allowAdultCheckbox.checked = true;
      showCheckinCard();
    } else {
      showOnboardingCard();
    }

    ageInput.addEventListener("input", () => {
      const age = Number(ageInput.value || 0);
      if (age < 18) {
        allowAdultCheckbox.checked = false;
        allowAdultCheckbox.disabled = true;
      } else {
        allowAdultCheckbox.disabled = false;
      }
    });

    document.getElementById("save-profile-btn").addEventListener("click", () => {
      const age = Number(ageInput.value || 0);
      if (!age || age < 13 || age > 120) {
        ageError.classList.remove("hidden");
        return;
      } else {
        ageError.classList.add("hidden");
      }

      const profile = {
        age,
        gender: genderSelect.value || null,
        liked_genres: getSelectedValues("liked-genres"),
        disliked_genres: getSelectedValues("disliked-genres"),
        goals: getSelectedValues("goals"),
        allow_adult: age >= 18 && allowAdultCheckbox.checked
      };

      saveProfileToStorage(profile);
      profileStatus.textContent = "Profile saved. SentiraX will use this as your base taste.";
      showCheckinCard();
    });

    async function fetchTitleDetails(id) {
      const detailsCard = document.getElementById("details-card");
      const titleEl = document.getElementById("details-title");
      const overviewEl = document.getElementById("details-overview");
      const metaEl = document.getElementById("details-meta");
      const castSection = document.getElementById("details-cast-section");
      const castList = document.getElementById("details-cast");
      const watchSection = document.getElementById("details-watch-section");
      const watchContainer = document.getElementById("details-watch");

      detailsCard.classList.remove("hidden");
      titleEl.textContent = "Loading details...";
      overviewEl.textContent = "";
      metaEl.textContent = "";
      castSection.classList.add("hidden");
      watchSection.classList.add("hidden");
      castList.innerHTML = "";
      watchContainer.innerHTML = "";

      try {
        const res = await fetch(`${getApiBase()}/api/title-details`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ id })
        });

        if (!res.ok) throw new Error("Failed to fetch details");

        const data = await res.json();

        titleEl.textContent = data.name || "Details";
        overviewEl.textContent = data.overview || "No summary available.";

        const metaBits = [];
        if (data.type) metaBits.push(data.type === "movie" ? "Movie" : "Series");
        if (data.release_date) metaBits.push(`Released: ${data.release_date}`);
        if (data.runtime_minutes) metaBits.push(`${data.runtime_minutes} min`);
        if (data.genres && data.genres.length) metaBits.push(`Genres: ${data.genres.join(", ")}`);
        if (data.vote_average) metaBits.push(`Rating: ${data.vote_average.toFixed(1)}/10`);

        metaEl.textContent = metaBits.join(" • ");

        if (data.cast && data.cast.length) {
          castList.innerHTML = "";
          data.cast.forEach(c => {
            const li = document.createElement("li");
            li.textContent = c.character
              ? `${c.name} as ${c.character}`
              : c.name;
            castList.appendChild(li);
          });
          castSection.classList.remove("hidden");
        }

        const wp = data.watch_providers || {};
        const groups = [
          { key: "flatrate", label: "Streaming" },
          { key: "rent", label: "Rent" },
          { key: "buy", label: "Buy" }
        ];

        let hasProviders = false;
        groups.forEach(g => {
          const list = wp[g.key] || [];
          if (!list.length) return;
          hasProviders = true;
          const groupDiv = document.createElement("div");
          groupDiv.className = "provider-group";

          const title = document.createElement("div");
          title.className = "provider-group-title";
          title.textContent = g.label;
          groupDiv.appendChild(title);

          const names = document.createElement("div");
          list.forEach((p, idx) => {
            const span = document.createElement("span");
            span.className = "provider-name";
            span.textContent = p.provider_name + (idx < list.length - 1 ? ", " : "");
            names.appendChild(span);
          });
          groupDiv.appendChild(names);

          watchContainer.appendChild(groupDiv);
        });

        if (hasProviders) {
          watchSection.classList.remove("hidden");
        }
      } catch (err) {
        console.error(err);
        titleEl.textContent = "Could not load details";
        overviewEl.textContent = "Something went wrong while fetching more information.";
      }
    }

    function createStreamingButtons(title) {
      const row = document.createElement("div");
      row.className = "stream-row";

      const encoded = encodeURIComponent(title);

      const nets = [
        { name: "Netflix", url: `https://www.netflix.com/search?q=${encoded}` },
        { name: "Prime Video", url: `https://www.primevideo.com/search?phrase=${encoded}` },
        { name: "Disney+", url: `https://www.disneyplus.com/search/${encoded}` },
        { name: "JustWatch", url: `https://www.justwatch.com/search?q=${encoded}` }
      ];

      nets.forEach(n => {
        const a = document.createElement("a");
        a.href = n.url;
        a.target = "_blank";
        a.rel = "noopener noreferrer";
        a.className = "stream-btn";
        a.textContent = n.name;
        row.appendChild(a);
      });

      return row;
    }

    document.getElementById("get-recs-btn").addEventListener("click", async () => {
      const profile = loadProfileFromStorage();
      if (!profile) {
        showOnboardingCard();
        return;
      }

      const moods = getSelectedValues("mood-chips");
      const freeText = document.getElementById("free-text").value.trim();
      const typeFilter = document.getElementById("type-filter").value;
      const maxDurationStr = document.getElementById("max-duration").value;
      const maxDuration = maxDurationStr ? Number(maxDurationStr) : null;

      const payload = {
        user_profile: profile,
        check_in: {
          moods,
          free_text: freeText,
          type_filter: typeFilter,
          max_duration_minutes: maxDuration
        }
      };

      const loadingEl = document.getElementById("loading");
      const recCard = document.getElementById("recommendations-card");
      const recList = document.getElementById("recommendations-list");
      const summaryEl = document.getElementById("summary");
      const errorEl = document.getElementById("checkin-error");
      const detailsCard = document.getElementById("details-card");

      loadingEl.classList.remove("hidden");
      recCard.classList.add("hidden");
      detailsCard.classList.add("hidden");
      errorEl.classList.add("hidden");
      errorEl.textContent = "";

      try {
        const res = await fetch(`${getApiBase()}/api/recommend`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        if (!res.ok) {
          throw new Error("Server error: " + res.status);
        }

        const data = await res.json();
        recList.innerHTML = "";

        (data.recommendations || []).forEach(item => {
          const div = document.createElement("div");
          div.className = "recommendation";

          const header = document.createElement("div");
          header.className = "rec-header";

          const titleWrap = document.createElement("div");
          const title = document.createElement("h4");
          title.textContent = item.name || item.title || "Untitled";
          titleWrap.appendChild(title);

          const meta = document.createElement("div");
          if (item.genres && item.genres.length) {
            item.genres.slice(0, 3).forEach(g => {
              const span = document.createElement("span");
              span.className = "badge";
              span.textContent = g;
              meta.appendChild(span);
            });
          }
          if (item.runtime_minutes) {
            const span = document.createElement("span");
            span.className = "badge";
            span.textContent = `${item.runtime_minutes} min`;
            meta.appendChild(span);
          }
          if (item.is_adult) {
            const span = document.createElement("span");
            span.className = "badge badge-18";
            span.textContent = "18+";
            meta.appendChild(span);
          }
          titleWrap.appendChild(meta);
          header.appendChild(titleWrap);

          const actions = document.createElement("div");
          const detailsBtn = document.createElement("button");
          detailsBtn.textContent = "More details";
          detailsBtn.addEventListener("click", (e) => {
            e.stopPropagation();
            fetchTitleDetails(item.id);
          });
          actions.appendChild(detailsBtn);
          header.appendChild(actions);

          div.appendChild(header);

          if (item.summary) {
            const p = document.createElement("p");
            p.className = "small";
            p.textContent = item.summary;
            div.appendChild(p);
          }

          if (item.reason) {
            const reason = document.createElement("p");
            reason.className = "small";
            reason.textContent = "Why SentiraX picked this: " + item.reason;
            div.appendChild(reason);
          }

          const streamRow = createStreamingButtons(item.name || item.title || "");
          div.appendChild(streamRow);

          recList.appendChild(div);
        });

        summaryEl.textContent =
          data.high_level_summary ||
          "Here’s what SentiraX thinks fits your current mood and preferences.";
        recCard.classList.remove("hidden");
      } catch (err) {
        console.error(err);
        errorEl.textContent = "Could not fetch SentiraX recommendations. Try again.";
        errorEl.classList.remove("hidden");
      } finally {
        loadingEl.classList.add("hidden");
      }
    });
  </script>
</body>
</html>
